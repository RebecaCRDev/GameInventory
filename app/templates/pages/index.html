<!-- app/templates/pages/index.html -->
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GameInventory</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/static/css/style.css" />
    <link rel="icon" href="/static/img/logo.png" />
  </head>

  <body>
    <nav class="navbar sticky-top navbar-expand-lg navbar-dark bg-dark">
      <div class="container">
        <a class="navbar-brand" href="/">
          <img class="logo" src="/static/img/logo.png" alt="logo" />
        </a>
        <button
          class="navbar-toggler border-0"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNavDropdown"
          aria-controls="navbarNavDropdown"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavDropdown">
          <ul class="navbar-nav ms-lg-auto">
            <li class="nav-item">
              <a
                class="nav-link {% if vista == 'activos' %}active{% endif %}"
                aria-current="page"
                href="/"
                >Activos</a
              >
            </li>
            <li class="nav-item">
              <a
                class="nav-link {% if vista == 'inactivos' %}active{% endif %}"
                href="/juegos/inactivos"
                >Inactivos</a
              >
            </li>
            <li class="nav-item">
              <a
                class="nav-link {% if vista == 'todos' %}active{% endif %}"
                href="/juegos/todos"
                >Todos</a
              >
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <main class="pt-5 bg-gradient-blue-green">
      <div class="container">
        <h1 class="text-center mb-4">Gestión de Videojuegos</h1>
        <p class="lead text-center mb-5">
          {% if vista == 'inactivos' %} Videojuegos inactivos (puedes
          reactivarlos con el botón de power). {% elif vista == 'todos' %} Todos
          los videojuegos (activos e inactivos). {% else %} Inventario de
          videojuegos activos. {% endif %}
        </p>
      </div>

      <div class="container mb-1 d-flex gap-2">
        <a href="/juegos/nuevo" class="btn btn-primary">
          <i class="bi bi-plus-lg me-2"></i>Agregar Videojuego
        </a>

        <a href="/juegos/inactivos" class="btn btn-outline-light">
          <i class="bi bi-eye-slash me-2"></i>Ver inactivos
        </a>

        <a href="/juegos/todos" class="btn btn-outline-light">
          <i class="bi bi-list-ul me-2"></i>Ver todos
        </a>
      </div>

      <section class="container mb-5 pb-5">
        <div class="table-responsive mt-3">
          <table class="table table-striped table-hover align-middle">
            <thead class="table-dark">
              <tr>
                <th>ID</th>
                <th>Código</th>
                <th>Título</th>
                <th>Plataforma</th>
                <th>Género</th>
                <th class="text-end">Precio</th>
                <th class="text-end">Stock</th>
                <th>Estado</th>
                <th class="text-end">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% if juegos|length == 0 %}
              <tr>
                <td colspan="9" class="text-center text-muted py-4">
                  No hay videojuegos para mostrar.
                </td>
              </tr>
              {% else %} {% for j in juegos %}
              <tr>
                <td>{{ j.id }}</td>
                <td>{{ j.codigo or '' }}</td>
                <td>{{ j.titulo }}</td>
                <td>{{ j.plataforma }}</td>
                <td>{{ j.genero or '' }}</td>
                <td class="text-end">{{ "%.2f"|format(j.precio) }} €</td>
                <td class="text-end">{{ j.stock }}</td>
                <td>
                  {% if j.estado == 1 %}
                  <span class="badge bg-success">Activo</span>
                  {% else %}
                  <span class="badge bg-secondary">Inactivo</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  <a
                    class="btn btn-sm btn-warning"
                    href="/juegos/editar/{{ j.id }}"
                  >
                    <i class="bi bi-pencil-square"></i>
                  </a>

                  <button
                    class="btn btn-sm btn-secondary btn-toggle"
                    data-id="{{ j.id }}"
                    type="button"
                  >
                    <i class="bi bi-power"></i>
                  </button>

                  <a
                    class="btn btn-sm btn-danger"
                    href="#"
                    data-id="{{ j.id }}"
                  >
                    <i class="bi bi-trash"></i>
                  </a>
                </td>
              </tr>
              {% endfor %} {% endif %}
            </tbody>
          </table>
        </div>
      </section>
    </main>

    <footer class="bg-dark p-3">
      <div class="container text-center">
        <small class="text-white">&copy; 2026 GameInventory.</small>
      </div>
    </footer>

    <!-- Modal de Confirmación de Eliminación -->
    <div
      class="modal fade"
      id="modalEliminar"
      tabindex="-1"
      aria-labelledby="modalEliminarLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="modalEliminarLabel">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>Confirmar
              Eliminación
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <p class="mb-0">
              <i class="bi bi-question-circle me-2"></i>
              ¿Está seguro que desea eliminar este videojuego?
            </p>
            <p class="text-muted small mb-0 mt-2">
              Esta acción no se puede deshacer.
            </p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              <i class="bi bi-x-circle me-1"></i>Cancelar
            </button>
            <button
              type="button"
              class="btn btn-danger"
              id="btnConfirmarEliminar"
            >
              <i class="bi bi-trash me-1"></i>Eliminar
            </button>
          </div>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
      crossorigin="anonymous"
    ></script>

    <script>
      let juegoIdEliminar = null;
      const modalEliminar = new bootstrap.Modal(
        document.getElementById("modalEliminar")
      );

      <!-- escucha donde hace click en la página, ve en qué botón ha hecho click (event delegation) -->
      document.addEventListener("click", function (e) {
        const btnDelete = e.target.closest(".btn-danger[data-id]");
        if (btnDelete) {
          e.preventDefault();
          juegoIdEliminar = btnDelete.getAttribute("data-id");
          modalEliminar.show();
          return;
        }

        const btnToggle = e.target.closest(".btn-toggle[data-id]");
        if (btnToggle) {
          e.preventDefault();
          const id = btnToggle.getAttribute("data-id");

          fetch(`/juegos/${id}/toggle`, { method: "PATCH" })
            .then((r) => r.json())
            .then((data) => {
              if (data.ok) window.location.reload();
              else alert(data.error || "Error al cambiar estado");
            })
            .catch(() => alert("Error al cambiar estado"));
        }
      });

      document
        .getElementById("btnConfirmarEliminar")
        .addEventListener("click", async function () {
          if (!juegoIdEliminar) return;

          try {
            const response = await fetch(`/juegos/${juegoIdEliminar}`, {
              method: "DELETE",
            });
            if (response.ok) {
              modalEliminar.hide();
              window.location.reload();
            } else {
              alert("Error al eliminar el videojuego");
            }
          } catch (error) {
            console.error("Error:", error);
            alert("Error al eliminar el videojuego");
          }
        });
    </script>
  </body>
</html>
